<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEDC Invitational — Admin</title>
  <style>
    :root{
      --bg:#070A12; --card:rgba(255,255,255,.04); --line:rgba(255,255,255,.10);
      --text:#EAF0FF; --muted:rgba(234,240,255,.75);
      --shadow:0 18px 60px rgba(0,0,0,.45); --r:18px;
      --blue:rgba(59,130,246,.22); --blueb:rgba(59,130,246,.35);
      --red:rgba(239,68,68,.18); --redb:rgba(239,68,68,.35);
      --green:rgba(34,197,94,.16); --greenb:rgba(34,197,94,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(7,10,18,.86);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:800;
    }
    .btn.primary{background:var(--blue);border-color:var(--blueb)}
    .btn.good{background:var(--green);border-color:var(--greenb)}
    .btn.danger{background:var(--red);border-color:var(--redb)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .cardPad{padding:16px}
    .grid2{display:grid;grid-template-columns:420px 1fr;gap:14px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    input,select,button{border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.22);color:var(--text);padding:10px 12px;outline:none}
    input{width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.20)}
    .itemTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .hide{display:none !important}
  </style>
</head>
<body>

<header>
  <div class="wrap bar">
    <div class="brand">
      <div>MEDC INVITATIONAL</div>
      <span class="pill" id="authPill">Locked</span>
      <span class="pill" id="rolePill">Role: —</span>
    </div>
    <div class="row">
      <button class="btn" type="button" onclick="location.href='index.html'">Public Page</button>
      <button id="logoutBtn" class="btn hide" type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- AUTH VIEW -->
  <section id="authView" class="card">
    <div class="cardPad">
      <h2>Login</h2>
      <p class="muted" style="margin:8px 0 14px">
        Users can register and will be <b>PENDING</b> until approved by owner.
      </p>

      <div class="grid2">
        <!-- Login -->
        <div class="item">
          <div class="muted">Email</div>
          <div style="margin-top:8px"><input id="loginEmail" type="email" placeholder="you@example.com"></div>

          <div class="muted" style="margin-top:12px">Password</div>
          <div style="margin-top:8px"><input id="loginPass" type="password" placeholder="Password"></div>

          <div class="row" style="margin-top:12px">
            <button id="loginBtn" class="btn primary" type="button">Login</button>
          </div>

          <div class="muted" id="loginMsg" style="margin-top:10px"></div>
        </div>

        <!-- Register -->
        <div class="item">
          <h3 style="margin:0">Request Admin Access</h3>
          <p class="muted" style="margin:8px 0 12px">Create an email/password account. Owner must approve you.</p>

          <div class="muted">Email</div>
          <div style="margin-top:8px"><input id="regEmail" type="email" placeholder="email@example.com"></div>

          <div class="muted" style="margin-top:12px">New password</div>
          <div style="margin-top:8px"><input id="regPass" type="password" placeholder="create password"></div>

          <div class="row" style="margin-top:12px">
            <button id="registerBtn" class="btn good" type="button">Register (Request)</button>
          </div>

          <div class="muted" id="regMsg" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ADMIN VIEW -->
  <section id="adminView" class="card hide" style="margin-top:14px">
    <div class="cardPad">
      <div class="grid2">
        <div class="item">
          <h2 style="margin:0">User Approvals</h2>
          <div class="muted" style="margin-top:6px">Approve/disable/delete admin accounts.</div>
          <div id="usersList" class="list" style="margin-top:12px"></div>
        </div>

        <div class="item">
          <h2 style="margin:0">Tournament Data</h2>
          <div class="muted" style="margin-top:6px">
            (This is just a placeholder box so your admin page still loads clean.)
            Your teams/bracket editor can be added below and saved to <b>Firestore: tournament/state</b>.
          </div>

          <div class="row" style="margin-top:12px">
            <button id="seedTournamentBtn" class="btn primary" type="button">Create tournament/state (empty)</button>
          </div>

          <div class="muted" id="tourMsg" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </section>

</div>

<script type="module">
  // Firebase (CDN modules) — works on GitHub Pages
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
    collection, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ✅ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDZAVhuz9SVBHSCPnEvoxwCjaMrZSQOJ6k",
    authDomain: "medcesport.firebaseapp.com",
    projectId: "medcesport",
    storageBucket: "medcesport.firebasestorage.app",
    messagingSenderId: "7933255333",
    appId: "1:7933255333:web:cfe776ebb79f607cdd774c",
    measurementId: "G-07Z2TFM553"
  };

  // ✅ IMPORTANT: replace this with YOUR UID (Authentication → Users → click your email → UID)
  const OWNER_UID = "bXZ3bSYPakQXEJGwtmkJjctD6Os1";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  function setPills(locked, roleText){
    $("authPill").textContent = locked ? "Locked" : "Unlocked";
    $("rolePill").textContent = "Role: " + roleText;
  }

  function isValidEmail(email){
    return /^\S+@\S+\.\S+$/.test(email);
  }

  function show(el, on){ el.classList.toggle("hide", !on); }

  function niceErr(e){
    return (e?.code ? e.code : "") + (e?.message ? " — " + e.message : "");
  }

  function isOwner(user){
    return user && user.uid === OWNER_UID;
  }

  async function ensureProfileDoc(user){
    // If user exists in Auth but missing Firestore profile, create it as pending
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, {
        email: user.email || "",
        status: "pending",
        createdAt: serverTimestamp()
      });
    }
    return (await getDoc(ref)).data();
  }

  // Register (Request)
  $("registerBtn").onclick = async () => {
    $("regMsg").textContent = "";
    try{
      const email = $("regEmail").value.trim();
      const pass = $("regPass").value;

      if(!isValidEmail(email)) return $("regMsg").textContent = "Enter a valid email.";
      if(pass.length < 6) return $("regMsg").textContent = "Password must be at least 6 characters.";

      const cred = await createUserWithEmailAndPassword(auth, email, pass);

      await setDoc(doc(db, "users", cred.user.uid), {
        email,
        status: "pending",
        createdAt: serverTimestamp()
      });

      $("regEmail").value = "";
      $("regPass").value = "";
      alert("Registered! Wait for owner approval.");
    } catch(e){
      $("regMsg").textContent = "Register failed: " + niceErr(e);
    }
  };

  // Login
  $("loginBtn").onclick = async () => {
    $("loginMsg").textContent = "";
    try{
      const email = $("loginEmail").value.trim();
      const pass = $("loginPass").value;

      if(!isValidEmail(email)) return $("loginMsg").textContent = "Enter a valid email.";
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e){
      $("loginMsg").textContent = "Login failed: " + niceErr(e);
      alert("Login failed: " + (e?.code || e?.message || e));
    }
  };

  // Logout
  $("logoutBtn").onclick = async () => {
    await signOut(auth);
  };

  // Render approvals
  async function renderApprovals(){
    const list = $("usersList");
    list.innerHTML = `<div class="muted">Loading...</div>`;

    const qs = await getDocs(collection(db, "users"));
    const users = [];
    qs.forEach(d => users.push({ uid: d.id, ...d.data() }));

    // pending first
    users.sort((a,b)=> (a.status===b.status?0 : a.status==="pending"?-1:1));

    list.innerHTML = "";
    if(users.length === 0){
      list.innerHTML = `<div class="muted">No requests yet.</div>`;
      return;
    }

    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div class="itemTop">
          <div>
            <b>${u.email || "(no email)"}</b>
            <div class="muted">Status: <b>${u.status || "pending"}</b></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn good" type="button">Approve</button>
            <button class="btn danger" type="button">Disable</button>
            <button class="btn" type="button">Delete</button>
          </div>
        </div>
      `;

      const [approveBtn, disableBtn, deleteBtn] = div.querySelectorAll("button");

      approveBtn.onclick = async () => {
        try{
          await updateDoc(doc(db,"users",u.uid), { status:"approved" });
          await renderApprovals();
        } catch(e){
          alert("Approve failed: " + niceErr(e));
        }
      };

      disableBtn.onclick = async () => {
        try{
          await updateDoc(doc(db,"users",u.uid), { status:"disabled" });
          await renderApprovals();
        } catch(e){
          alert("Disable failed: " + niceErr(e));
        }
      };

      deleteBtn.onclick = async () => {
        if(!confirm(`Delete request for ${u.email || u.uid}?`)) return;
        try{
          // NOTE: This deletes the Firestore profile/approval doc.
          // It does NOT delete the Firebase Auth user (that requires server/admin SDK).
          await deleteDoc(doc(db,"users",u.uid));
          await renderApprovals();
        } catch(e){
          alert("Delete failed: " + niceErr(e));
        }
      };

      list.appendChild(div);
    });
  }

  // Create empty tournament doc
  $("seedTournamentBtn").onclick = async () => {
    $("tourMsg").textContent = "";
    try{
      await setDoc(doc(db,"tournament","state"), {
        teams: [],
        rosters: {},
        matches: [],
        bracketSize: 8,
        updatedAt: serverTimestamp()
      }, { merge: true });

      $("tourMsg").textContent = "Created/updated tournament/state.";
    } catch(e){
      $("tourMsg").textContent = "Failed: " + niceErr(e);
    }
  };

  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      setPills(true, "—");
      show($("logoutBtn"), false);
      show($("authView"), true);
      show($("adminView"), false);
      return;
    }

    show($("logoutBtn"), true);

    // Owner gets full access
    if(isOwner(user)){
      setPills(false, "Owner");
      show($("authView"), false);
      show($("adminView"), true);
      await renderApprovals();
      return;
    }

    // Non-owner must be approved
    try{
      const prof = await ensureProfileDoc(user);
      if(prof.status !== "approved"){
        alert(`Not approved yet. Current status: ${prof.status || "pending"}`);
        await signOut(auth);
        return;
      }

      setPills(false, "Admin");
      show($("authView"), false);
      show($("adminView"), true);

      // Optional: admins can see approvals or not — you can decide:
      // For now: hide approvals for non-owner by clearing list
      $("usersList").innerHTML = `<div class="muted">Owner only.</div>`;
    } catch(e){
      alert("Auth check failed (" + (e?.code || e?.message || e) + ").");
      await signOut(auth);
    }
  });
</script>

</body>
</html>
